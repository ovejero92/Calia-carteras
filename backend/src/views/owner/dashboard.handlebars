<div class="panel-layout" style="display: flex;">
    {{> sidebar }} 
    <main class="panel-content" style="flex-grow: 1; padding: 20px;">
        <div style="margin-bottom: 30px;">
            <h1 style="margin: 0 0 10px;">Bienvenido, {{user.email}}</h1>
            <p style="color: #666; margin: 0;">Panel de control del negocio</p>
        </div>

        <!-- M√©tricas Principales -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- Ingresos del Mes -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Ingresos del Mes</div>
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">
                    ${{formatCurrency stats.recent.thisMonth.totalRevenue}}
                </div>
                <div style="font-size: 12px; opacity: 0.8;">{{#if stats.recent.thisMonth.totalSales}}{{stats.recent.thisMonth.totalSales}}{{else}}0{{/if}} ventas</div>
            </div>

            <!-- Ventas de Hoy -->
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Ventas de Hoy</div>
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">
                    ${{formatCurrency stats.recent.today.totalRevenue}}
                </div>
                <div style="font-size: 12px; opacity: 0.8;">{{#if stats.recent.today.totalSales}}{{stats.recent.today.totalSales}}{{else}}0{{/if}} ventas</div>
            </div>

            <!-- Productos Totales -->
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Productos en Stock</div>
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">
                    {{stats.products.total}}
                </div>
                <div style="font-size: 12px; opacity: 0.8;">{{stats.products.lowStock}} con stock bajo</div>
            </div>

            <!-- Usuarios Activos -->
            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Clientes Activos</div>
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">
                    {{stats.users.activos}}
                </div>
                <div style="font-size: 12px; opacity: 0.8;">{{stats.users.total}} total usuarios</div>
            </div>
        </div>

        <!-- Estad√≠sticas Detalladas -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
            <!-- Estad√≠sticas de Ventas -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2 style="margin: 0 0 20px; color: #333; font-size: 20px;">üìä Resumen de Ventas (√öltimos 30 d√≠as)</h2>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Ventas</div>
                        <div style="font-size: 24px; font-weight: bold; color: #007bff;">
                            {{#if stats.recent.last30Days.totalSales}}{{stats.recent.last30Days.totalSales}}{{else}}0{{/if}}
                        </div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Ingresos Totales</div>
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">
                            ${{formatCurrency stats.recent.last30Days.totalRevenue}}
                        </div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Productos Vendidos</div>
                        <div style="font-size: 24px; font-weight: bold; color: #ffc107;">
                            {{#if stats.recent.last30Days.totalItems}}{{stats.recent.last30Days.totalItems}}{{else}}0{{/if}}
                        </div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Promedio por Venta</div>
                        <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">
                            ${{formatCurrency stats.recent.last30Days.averageSale}}
                        </div>
                    </div>
                </div>

                <!-- M√©todos de Pago -->
                {{#if stats.recent.last30Days.paymentMethods}}
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h3 style="margin: 0 0 15px; font-size: 16px; color: #333;">M√©todos de Pago</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        {{#each stats.recent.last30Days.paymentMethods}}
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="text-transform: capitalize; font-weight: 500;">{{@key}}</span>
                                <span style="font-weight: bold; color: #007bff;">${{this.total}}</span>
                            </div>
                            <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #007bff; height: 100%; width: {{#if ../stats.recent.last30Days.totalRevenue}}{{percent this.total ../stats.recent.last30Days.totalRevenue}}{{else}}0{{/if}}%;"></div>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 2px;">{{this.count}} ventas</div>
                        </div>
                        {{/each}}
                    </div>
                </div>
                {{/if}}
            </div>

            <!-- Productos y Alerts -->
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Estado de Productos -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h2 style="margin: 0 0 20px; color: #333; font-size: 18px;">üì¶ Estado de Productos</h2>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                            <div style="font-size: 12px; color: #666;">Total Productos</div>
                            <div style="font-size: 20px; font-weight: bold; color: #007bff;">{{stats.products.total}}</div>
                        </div>
                        <div style="padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="font-size: 12px; color: #666;">Stock Bajo (‚â§5)</div>
                            <div style="font-size: 20px; font-weight: bold; color: #ffc107;">{{stats.products.lowStock}}</div>
                        </div>
                        <div style="padding: 12px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                            <div style="font-size: 12px; color: #666;">Sin Stock</div>
                            <div style="font-size: 20px; font-weight: bold; color: #dc3545;">{{stats.products.outOfStock}}</div>
                        </div>
                        <div style="padding: 12px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #17a2b8;">
                            <div style="font-size: 12px; color: #666;">Valor Total Inventario</div>
                            <div style="font-size: 20px; font-weight: bold; color: #17a2b8;">${{formatCurrency stats.products.totalValue}}</div>
                        </div>
                    </div>
                </div>

                <!-- Productos M√°s Vendidos -->
                {{#if stats.recent.last30Days.topProducts.length}}
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h2 style="margin: 0 0 20px; color: #333; font-size: 18px;">üèÜ Top 5 Productos</h2>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        {{#each stats.recent.last30Days.topProducts}}
                        <div style="padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-weight: 500; margin-bottom: 5px;">{{this.productName}}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                                <span>{{this.quantity}} vendidos</span>
                                <span style="font-weight: bold; color: #28a745;">${{formatCurrency this.revenue}}</span>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>
                {{/if}}
            </div>
        </div>

        <!-- Acciones R√°pidas -->
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="margin: 0 0 20px; color: #333; font-size: 20px;">‚ö° Acciones R√°pidas</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <a href="/owner/sales" style="display: block; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; text-align: center; font-weight: 500;">
                    üí∞ Nueva Venta
                </a>
                <a href="/owner/products" style="display: block; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; text-decoration: none; border-radius: 8px; text-align: center; font-weight: 500;">
                    üì¶ Agregar Producto
                </a>
                <a href="/owner/users" style="display: block; padding: 15px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; text-decoration: none; border-radius: 8px; text-align: center; font-weight: 500;">
                    üë• Agregar Cliente
                </a>
                <a href="/owner/sales" style="display: block; padding: 15px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; text-decoration: none; border-radius: 8px; text-align: center; font-weight: 500;">
                    üìä Ver Reportes
                </a>
            </div>
        </div>
    </main>
</div>

<script>
    // Actualizar datos cada 5 minutos
    setInterval(async () => {
        try {
            const res = await fetch('/owner/stats');
            const result = await res.json();
            if (result.status === 'success') {
                location.reload(); // Simple refresh - podr√≠as hacerlo m√°s sofisticado
            }
        } catch (err) {
            console.error('Error actualizando stats:', err);
        }
    }, 300000); // 5 minutos
</script>
